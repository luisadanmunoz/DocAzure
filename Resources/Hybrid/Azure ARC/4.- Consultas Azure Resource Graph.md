## 1. Administrar VM ARC


```kusto
// Listar todos los recursos habilitados para Azure Arc
Resources
| where type == "microsoft.hybridcompute/machines"
| project name, id, location, resourceGroup, subscriptionId, properties.osName, properties.status
```

```kusto
// Listar servidores Arc por sistema operativo
Resources
| where type == "microsoft.hybridcompute/machines"
| summarize count() by tostring(properties.osName)
```

```kusto
// Servidores Arc por ubicación (region)
Resources
| where type == "microsoft.hybridcompute/machines"
| summarize count() by location
```

```kusto
// Obtener etiquetas de los servidores Arc
Resources
| where type == "microsoft.hybridcompute/machines"
| project name, resourceGroup, tags
```

```kusto
// Ver estado de conectividad de máquinas Arc
Resources
| where type == "microsoft.hybridcompute/machines"
| project name, location, resourceGroup, properties.status
```

```kusto
// Ver últimas actualizaciones de estado/reporting
Resources
| where type == "microsoft.hybridcompute/machines"
| project name, properties.lastStatusChange
```

```kusto
// Ver estado de Defender for Cloud en máquinas Arc
SecurityResources
| where type == "microsoft.security/assessments"
| where properties.resourceDetails.id contains "microsoft.hybridcompute/machines"
| project assessmentName = name, status = properties.status.code, resourceId = properties.resourceDetails.id

```

```kusto
// Evaluar cumplimiento de políticas en recursos Azure Arc
PolicyResources
| where type == "microsoft.policyinsights/policystates"
| where properties.resourceId contains "microsoft.hybridcompute/machines"
| project resourceId = properties.resourceId, policyDefinitionName = properties.policyDefinitionName, complianceState = properties.complianceState
```

```kusto
// Ver insights del agente de Azure Monitor en Arc
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where name == "AzureMonitorWindowsAgent" or name == "AzureMonitorLinuxAgent"
| project machineName = split(id, "/")[8], extensionName = name, provisioningState = properties.provisioningState, version = properties.typeHandlerVersion

```

```kusto
// Buscar servidores Arc con extensiones en error
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where tostring(properties.provisioningState) != "Succeeded"
| project machineName = split(id, "/")[8], extensionName = name, provisioningState = properties.provisioningState
```

```kusto
// Servidores por Sistema Operativo
resources
| where type =~ 'microsoft.hybridcompute/machines'
| extend OSVersion = tostring(properties.osSku)
| project OSVersion
| summarize ServerCount = count() by OSVersion
| order by ServerCount desc  
```

```kusto
// Organizados por version de agente
 resources
| where type == "microsoft.hybridcompute/machines"
| summarize count() by tostring(properties.agentVersion) 
```

```kusto
// Organizados por OS e indica defender monitoring wac updatemanager
resources
| where type =~ 'microsoft.hybridcompute/machines' and kind !contains "AVS"
| extend machineId = tolower(tostring(id))
| extend hostId = tolower(id)
| join kind=leftouter (
    connectedVMwarevSphereResources
    | where type =~ 'microsoft.connectedvmwarevsphere/virtualmachineinstances'
    | extend guestId = tolower(id)
    | extend indexOfHostId = indexof(guestId, tolower("/providers/Microsoft.ConnectedVMwarevSphere/VirtualMachineInstances/default"))
    | extend hostId = substring(guestId, 0, indexOfHostId)
    | extend guestProperties = properties
    | extend guestExtendedLocation = extendedLocation
    | extend vCenterId = properties.infrastructureProfile.vCenterId
    | project hostId, guestId, guestProperties, guestExtendedLocation, vCenterId
) on $left.hostId == $right.hostId
| extend datacenter = iif(isnull(tags.Datacenter), '', tags.Datacenter)
| extend state = properties.status
| extend status = case(
    state =~ 'Connected', 'Connected',
    state =~ 'Disconnected', 'Offline',
    state =~ 'Error', 'Error',
    state =~ 'Expired', 'Expired',
    '')
| extend osSku = properties.osSku
| extend os = properties.osName
| extend osName = case(
    os =~ 'windows', 'Windows',
    os =~ 'linux', 'Linux',
    '')
| extend extensionsEnabled = tostring(properties.agentConfiguration.extensionsEnabled)
| extend operatingSystem = iif(isnotnull(osSku), osSku, osName)
| join kind=leftouter (
    resources
    | where type =~ "microsoft.hybridcompute/machines/extensions"
    | extend machineId = tolower(tostring(trim_end(@"\/\w+\/(\w|\.)+", id)))
    | extend provisioned = tolower(tostring(properties.provisioningState)) == "succeeded"
    | summarize
        MDEcnt = countif(properties.type in ("MDE.Linux", "MDE.Windows") and provisioned),
        AMAcnt = countif(properties.type in ("AzureMonitorWindowsAgent", "AzureMonitorLinuxAgent") and provisioned),
        WACcnt = countif(properties.type in ("AdminCenter") and provisioned),
        UMcnt = countif(properties.type in ("WindowsOsUpdateExtension","LinuxOsUpdateExtension", "WindowsPatchExtension") and provisioned) by machineId
) on machineId
| extend defenderStatus = iff ((MDEcnt>0), 'Enabled', 'Not enabled')
| extend monitoringAgent = iff ((AMAcnt>0), 'Installed','Not installed')
| extend wacStatus = iff ((WACcnt>0), 'Enabled', 'Not enabled')
| extend updateManagement = iff ((UMcnt>0), 'Enabled', 'Not enabled')
| extend hostName = tostring(properties.displayName)
| extend hostEnvironment = vCenterId
| extend name = iif(properties.cloudMetadata.provider == 'AWS' and name != hostName, strcat(name, "(", hostName, ")"), name)
| project name, status, resourceGroup, operatingSystem, extensionsEnabled, defenderStatus, monitoringAgent, wacStatus, updateManagement
```


## 2. Administrar SQL ARC

```kusto
// Listar todas las instancias de SQL Server habilitadas con Azure Arc
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project name, location, resourceGroup, subscriptionId, properties.version, properties.edition, properties.status

```

```kusto
// Ver etiquetas asociadas a instancias de SQL Server Arc
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project name, resourceGroup, tags
```

```kusto
// Contar instancias de SQL por versión
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| summarize count() by tostring(properties.version)
```

```kusto
// Ver extensiones o características habilitadas en SQL Server Arc
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project name, features = properties.features
```

```kusto
// Ver nivel de licencia reportado por instancias de SQL Server Arc
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project name, licenseType = properties.licenseType
```

```kusto
// Última sincronización o reporte de estado
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project name, lastReportedAt = properties.lastUpdatedTime
```

```kusto
// Ver nivel de licencia reportado por instancias de SQL Server Arc
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project name, licenseType = properties.licenseType
```

```kusto
// Consultar tipo de licencia en instancias SQL Server Arc
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project name, resourceGroup, licenseType = properties.licenseType
```

```kusto
// Identificar instancias con Azure Hybrid Benefit habilitado
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| where tostring(properties.licenseType) == "BasePrice"
| project name, location, resourceGroup
```

```kusto
// Ver estado de seguridad con Microsoft Defender for SQL
SecurityResources
| where type == "microsoft.security/assessments"
| where properties.resourceDetails.id contains "microsoft.azurearcdata/sqlserverinstances"
| project assessmentName = name, status = properties.status.code, resourceId = properties.resourceDetails.id
```

```kusto
// Evaluar cumplimiento de políticas (Azure Policy) en SQL Arc
PolicyResources
| where type == "microsoft.policyinsights/policystates"
| where properties.resourceId contains "microsoft.azurearcdata/sqlserverinstances"
| project resourceId = properties.resourceId, policyDefinitionName = properties.policyDefinitionName, complianceState = properties.complianceState
```
```kusto
// Organizado en versiones de SQL
resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
//| where type == "microsoft.hybridcompute/machines"
//| where properties.detectedProperties.mssqldiscovered == "true"
| extend d=parse_json(properties)
| extend Patch=d["patchLevel"]
| extend SQLVersion=tostring(d["version"])
| extend  Edition=d["edition"]
| extend License=d["licenseType"]
| project name, Patch, SQLVersion, Edition, License
| summarize SQLServerVersionCount=count() by SQLVersion
| order by SQLServerVersionCount desc 
```


## 3. Administrar Kubernetes ARC

```kusto
// Listar clústeres Kubernetes habilitados con Azure Arc
Resources
| where type == "microsoft.kubernetes/connectedclusters"
| project name, location, resourceGroup, subscriptionId, properties.kubernetesVersion, properties.distribution, properties.provisioningState

```

```kusto
// Contar clústeres Arc por distribución
Resources
| where type == "microsoft.kubernetes/connectedclusters"
| summarize count() by tostring(properties.distribution)
```

```kusto
// Ver fecha de última sincronización
Resources
| where type == "microsoft.kubernetes/connectedclusters"
| project name, lastConnected = properties.agentPublicKeyCertificateLastUpdatedTime

```

```kusto
// Listar extensiones instaladas en clústeres Arc
Resources
| where type == "microsoft.kubernetes/connectedclusters/extensions"
| project clusterName = split(id, "/")[8], extensionName = name, extensionType = properties.extensionType, provisioningState = properties.provisioningState
```

```kusto
// Detectar extensiones en error o estado no exitoso
Resources
| where type == "microsoft.kubernetes/connectedclusters/extensions"
| where tostring(properties.provisioningState) != "Succeeded"
| project clusterName = split(id, "/")[8], extensionName = name, provisioningState = properties.provisioningState
```

```kusto
// Defender for Containers en clústeres Arc
SecurityResources
| where type == "microsoft.security/assessments"
| where properties.resourceDetails.id contains "microsoft.kubernetes/connectedclusters"
| project assessmentName = name, status = properties.status.code, resourceId = properties.resourceDetails.id
```

```kusto
// Evaluar cumplimiento de políticas en clústeres Arc
PolicyResources
| where type == "microsoft.policyinsights/policystates"
| where properties.resourceId contains "microsoft.kubernetes/connectedclusters"
| project resourceId = properties.resourceId, policyDefinitionName = properties.policyDefinitionName, complianceState = properties.complianceState
```