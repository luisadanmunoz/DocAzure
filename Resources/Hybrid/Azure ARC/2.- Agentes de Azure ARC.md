


| DescripciÃ³n                                                                | URL                                                                                                                                                                                                                                                                        | Notas |
| -------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----- |
| Uso de Azure Policy para instalar y administrar el agente de Azure Monitor | https://learn.microsoft.com/es-es/azure/azure-monitor/agents/azure-monitor-agent-policy                                                                                                                                                                                    |       |
| Agente de Azure Arc                                                        | https://learn.microsoft.com/es-es/azure/azure-arc/vmware-vsphere/azure-arc-agent                                                                                                                                                                                           |       |
| AMA                                                                        | https://learn.microsoft.com/es-es/azure/azure-monitor/agents/azure-monitor-agent-overview                                                                                                                                                                                  |       |
| Extensiones VM                                                             | https://learn.microsoft.com/es-es/azure/azure-arc/servers/manage-vm-extensions                                                                                                                                                                                             |       |
| Policy                                                                     | https://learn.microsoft.com/en-us/azure/azure-arc/servers/policy-reference                                                                                                                                                                                                 |       |
| Defender                                                                   | https://learn.microsoft.com/es-es/azure/defender-for-cloud/support-matrix-defender-for-servers                                                                                                                                                                             |       |
| Dashboards                                                                 | https://github.com/weeyin83/Azure-Arc-Windows-Linux-Dashboard<br><br>https://github.com/microsoft/sql-server-samples/blob/master/samples/features/azure-arc/dashboard/Arc%20-%20Deployment%20Progress.json<br><br>https://github.com/markjones-msft/ArcDashboard/tree/main |       |
| Sentinel                                                                   | https://learn.microsoft.com/es-es/azure/azure-arc/servers/scenario-onboard-azure-sentinel                                                                                                                                                                                  |       |
| Update Manager                                                             | https://learn.microsoft.com/es-es/azure/azure-arc/servers/onboard-update-management-machines                                                                                                                                                                               |       |
| AMPL                                                                       | https://learn.microsoft.com/es-es/azure/azure-monitor/logs/private-link-security                                                                                                                                                                                           |       |
| Jumpstart                                                                  | https://jumpstart.azure.com/azure_jumpstart_arcbox/workbook/flavors/ITPro                                                                                                                                                                                                  |       |
## 1. Audita extensiones


```kusto
Resources
| where type == "microsoft.hybridcompute/machines/extensions"         // \\ Filtra extensiones instaladas en servidores Azure Arc
| extend machineName = split(id, "/")[8]                              // \\ Extrae el nombre del servidor desde el ID del recurso
| project
    machineName,                                                      // \\ Nombre del servidor Azure Arc
    extensionName = name,                                             // \\ Nombre de la extensiÃ³n instalada
    publisher = properties.publisher,                                 // \\ Editor de la extensiÃ³n (Microsoft.X)
    typeHandlerVersion = properties.typeHandlerVersion,               // \\ VersiÃ³n del agente/extensiÃ³n
    provisioningState = properties.provisioningState,                 // \\ Estado del aprovisionamiento (Succeeded, Failed, etc.)
    autoUpgradeMinorVersion = properties.autoUpgradeMinorVersion,     // \\ Â¿Permite actualizaciÃ³n automÃ¡tica de versiones menores?
    enableAutomaticUpgrade = properties.enableAutomaticUpgrade        // \\ Â¿Permite actualizaciÃ³n automÃ¡tica completa?

```
## 2. Azure Arc-enabled Servers

### ðŸ”§ Agentes disponibles:

| Agente / Funcionalidad               | Nombre real de la extensiÃ³n (`name`)                       | Requiere DCR | DescripciÃ³n                                           |
| ------------------------------------ | ---------------------------------------------------------- | ------------ | ----------------------------------------------------- |
| Agente base de Azure Arc             | `AzureConnectedMachineAgent` _(no visible como extensiÃ³n)_ | âŒ            | Permite registrar la mÃ¡quina en Azure Arc             |
| Azure Monitor Agent (AMA)            | `AzureMonitorWindowsAgent` / `AzureMonitorLinuxAgent`      | âœ…            | EnvÃ­a mÃ©tricas y logs a Log Analytics via DCR         |
| Log Analytics Agent (Legacy MMA)     | `MicrosoftMonitoringAgent`                                 | âŒ            | Obsoleto, aÃºn presente en algunas implementaciones    |
| Dependency Agent                     | `DependencyAgentWindows` / `DependencyAgentLinux`          | âŒ            | Usado para mapas de dependencias (Insights)           |
| Azure Automation Hybrid Worker       | `HybridWorkerExtension`                                    | âŒ            | Ejecuta runbooks de Azure Automation localmente       |
| GestiÃ³n de actualizaciones (Linux)   | `LinuxOsUpdateExtension`                                   | âŒ            | Permite aplicar updates desde Azure                   |
| GestiÃ³n de actualizaciones (Windows) | `WindowsOsUpdateExtension`, `WindowsPatchExtension`        | âŒ            | Gestiona parches de Windows                           |
| Custom script (Crowdstrike, scripts) | `CustomScriptCrowdstrike`, `CustomScriptListUsers`, etc.   | âŒ            | Scripts personalizados para instalaciÃ³n/configuraciÃ³n |
## 3. Azure Arc-enabled SQL Server

### ðŸ”§ Agentes disponibles:

| Funcionalidad principal                  | Nombre real de la extensiÃ³n o recurso                                   | Requiere DCR | DescripciÃ³n                                                                |
| ---------------------------------------- | ----------------------------------------------------------------------- | ------------ | -------------------------------------------------------------------------- |
| Registro del motor SQL Server            | `WindowsAgent.SqlServer`                                                | âŒ            | Agente que conecta instancias SQL Server locales con Azure Arc.            |
| Instancia SQL registrada en Azure Arc    | _(instancia registrada)_                                                | âŒ            | Representa una instancia de SQL Server registrada en Arc (inventario).     |
| Licenciamiento (AHB / BYOL)              | Parte de `WindowsAgent.SqlServer`                                       | âŒ            | Configura tipo de licencia: `BasePrice` (AHB) o `LicenseIncluded`.         |
| Defender for SQL                         | _(no se instala como extensiÃ³n)_                                        | âŒ            | Detecta vulnerabilidades y amenazas en SQL. Visible en Defender for Cloud. |
| EvaluaciÃ³n de cumplimiento con polÃ­ticas | _(no es extensiÃ³n, sino evaluaciÃ³n)_                                    | âŒ            | EvalÃºa si las instancias SQL cumplen con polÃ­ticas asignadas.              |
| Logs y mÃ©tricas desde el host (Windows)  | `AzureMonitorWindowsAgent` _(AMA)_ o `MicrosoftMonitoringAgent` _(MMA)_ | âœ… / âŒ        | Permite capturar mÃ©tricas, logs y desempeÃ±o del sistema operativo.         |

> ðŸ“Œ Los datos se envÃ­an a travÃ©s de la extensiÃ³n de SQL Arc, no AMA directamente.

##  4. Azure Arc-enabled Kubernetes Clusters


### ðŸ”§ Agentes disponibles / Extensiones:

| Agente / Funcionalidad          | Nombre real de la extensiÃ³n (`name`)                | Requiere DCR          | DescripciÃ³n                                            |
| ------------------------------- | --------------------------------------------------- | --------------------- | ------------------------------------------------------ |
| Registro base (Cluster Connect) | _(No visible como extensiÃ³n, parte del agente Arc)_ | âŒ                     | Registro del clÃºster y habilita la conectividad remota |
| Azure Monitor for Containers    | `ContainerInsights`                                 | âŒ _(usa DCR interno)_ | Observabilidad y mÃ©tricas del clÃºster Arc              |
| GitOps (Flux v2)                | `fluxExtension`                                     | âŒ                     | AplicaciÃ³n de configuraciones declarativas desde Git   |
| Azure Policy para K8s           | `arcPolicyAgent` / `azurepolicy`                    | âŒ                     | EvalÃºa y aplica polÃ­ticas de cumplimiento              |
| Defender for Containers         | `mde` o parte de Defender for Cloud                 | âŒ                     | Seguridad para workloads de contenedores               |

> ðŸ“Œ Las extensiones se instalan en el clÃºster como _Kubernetes resources_, no agentes tradicionales.

## 5. Auditar Agente - AzureConnectedMachineAgent 

## Resource graph explorer

```kusto
// Si tiene microsoft.hybridcompute/machines es porque tiene el agente AzureConnectedMachineAgent
Resources
| where type == "microsoft.hybridcompute/machines"
| project name, id, location, resourceGroup, subscriptionId, properties.osName, properties.status
```

> ðŸ“Œ Agente necesario para enrolar VM
## 6. Auditar Agente - AMA

> ðŸ“Œ Los datos se envÃ­an a travÃ©s de la extensiÃ³n de SQL Arc, no AMA directamente.
## 7. Auditar Agente - Legacy MMA

## Resource graph explorer

```kusto
// Si tiene MicrosoftMonitoringAgent
| where type == "microsoft.hybridcompute/machines/extensions"
| where name =~ "MicrosoftMonitoringAgent"
| extend machineName = split(id, "/")[8]
| project machineName, 
          resourceGroup,
          location,
          provisioningState = properties.provisioningState,
          version = properties.typeHandlerVersion,
          publisher = properties.publisher
```

> ðŸ“Œ Agente en desuso

## 8. Auditar Agente - Azure Automation Hybrid Worker

## Resource graph explorer

```kusto
// Si tiene HybridWorkerExtension
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where name =~ "HybridWorkerExtension"
| extend machineName = split(id, "/")[8]
| project machineName,
          provisioningState = properties.provisioningState,
          version = properties.typeHandlerVersion,
          publisher = properties.publisher,
          resourceGroup,
          location

```

> ðŸ“Œ Esta extensiÃ³n permite que la VM Arc actÃºe como **Hybrid Runbook Worker** para ejecutar **Azure Automation Runbooks on-premises o fuera de Azure**.
> ðŸ“Œ Para que funcione correctamente, debe estar registrada tambiÃ©n en una **Azure Automation Account** (esto no se ve directamente desde ARG, pero sÃ­ desde el portal de Automation).

## 9. Auditar Agente - GestiÃ³n de actualizaciones (Linux)

## Resource graph explorer

```kusto
// Si tiene LinuxOsUpdateExtension
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where name =~ "LinuxOsUpdateExtension"
| extend machineName = split(id, "/")[8]
| project machineName,
          provisioningState = properties.provisioningState,
          version = properties.typeHandlerVersion,
          publisher = properties.publisher,
          resourceGroup,
          location

```

> ðŸ“Œ Esta extensiÃ³n permite usar **Azure Update Management** para aplicar parches desde Azure a **Linux** Arc VMs.
 > ðŸ“Œ Esta extensiÃ³n puede ser instalada manualmente o desde soluciones como **Guest Configuration** o **Policies**.
 
## 10. Auditar Agente - GestiÃ³n de actualizaciones (Windows)

## Resource graph explorer

```kusto
// Si tiene WindowsOsUpdateExtension y WindowsPatchExtension
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where name in~ ("WindowsOsUpdateExtension", "WindowsPatchExtension")
| extend machineName = split(id, "/")[8]
| project machineName,
          extensionName = name,
          provisioningState = properties.provisioningState,
          version = properties.typeHandlerVersion,
          publisher = properties.publisher,
          resourceGroup,
          location
```

> ðŸ“Œ Se suelen utilizar junto con: Azure Automation Account, Update Management y Azure Policy (para gobernanza)

## 11. Auditar Agente - ExtensiÃ³n Custom script

## Resource graph explorer

```kusto
// Si tiene CustomScriptExtension
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where properties.publisher =~ "Microsoft.Azure.Extensions"
| where properties.type =~ "CustomScriptExtension"
| extend machineName = split(id, "/")[8]
| project machineName, extensionName = name, provisioningState = properties.provisioningState, version = properties.typeHandlerVersion
```

> ðŸ“Œ Se suelen utilizar junto con: Azure Automation Account, Update Management y Azure Policy (para gobernanza)

## 12. Auditar Agente - Registro del motor SQL Server

## Resource graph explorer

```kusto
// Si tiene WindowsAgent.SqlServer
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where name =~ "WindowsAgent.SqlServer"
| extend machineName = split(id, "/")[8]
| project machineName,
          provisioningState = properties.provisioningState,
          version = properties.typeHandlerVersion,
          publisher = properties.publisher,
          resourceGroup,
          location

```

> ðŸ“Œ Se suelen utilizar junto con: Azure Automation Account, Update Management y Azure Policy (para gobernanza)

## 13. Auditar Agente - instancias de SQL Server

## Resource graph explorer

```kusto
// Si tiene microsoft.azurearcdata/sqlserverinstances
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project instanceName = name,
          location,
          resourceGroup,
          subscriptionId,
          version = properties.version,
          edition = properties.edition,
          licenseType = properties.licenseType,
          status = properties.status,
          lastUpdated = properties.lastUpdatedTime,
          connectedVmResourceId = properties.extendedLocation.name
```

> ðŸ“Œ Se suelen utilizar junto con: Azure Automation Account, Update Management y Azure Policy (para gobernanza)

## 14. Auditar Agente - licenciamiento AHB en instancias SQL

## Resource graph explorer

```kusto
// Si tiene microsoft.azurearcdata/sqlserverinstances
Resources
| where type == "microsoft.azurearcdata/sqlserverinstances"
| project instanceName = name,
          licenseType = properties.licenseType,
          licenseStatus = case(
              properties.licenseType in ("BasePrice"), "AHB (BYOL)",
              properties.licenseType in ("LicenseIncluded", "PAYG"), "License Included (PAYG)",
              isempty(properties.licenseType), "Not Set",
              "Unknown"
          )

```

> ðŸ“Œ SÃ­, todas tus instancias SQL Arc estÃ¡n bajo modelo PAYG**, es decir, pagan licencia completa a Microsoft por hora.
> ðŸ“Œ Si ya tienes licencias SQL con Software Assurance, podrÃ­as considerar cambiar a `BasePrice` para activar Azure Hybrid Benefit y ahorrar costos.
>  ðŸ“Œ HADR revisar con Unknown

## 15. Auditar Agente - Evaluar Defender for SQL 

## Resource graph explorer

```kusto
// Si tiene microsoft.security/pricings
SecurityResources
| where type == "microsoft.security/pricings"
| where name == "SqlServers"  // <- cobertura de SQL
| project subscriptionId, pricingTier = properties.pricingTier, resourceType = name
```

> ðŸ“Œ Muestra si **Defender for SQL estÃ¡ habilitado** (`pricingTier = "Standard"`) o deshabilitado (`Free`) en tus suscripciones.
> ðŸ“Œ Aplica a **todas las instancias SQL, incluyendo Arc**.

## 16. Auditar Agente - Evaluaciones de seguridad activas

## Resource graph explorer

```kusto
// Si tiene microsoft.security/assessments
SecurityResources
| where type == "microsoft.security/assessments"
| where properties.resourceDetails.id contains "microsoft.azurearcdata/sqlserverinstances"
| project assessmentName = name,
          status = properties.status.code,
          resourceId = properties.resourceDetails.id,
          timeGenerated = properties.timeGenerated

```

> ðŸ“Œ Evaluaciones de seguridad de Defender for SQL para instancias Arc.
> ðŸ“Œ Estado: `Healthy`, `Unhealthy`, etc.
> ðŸ“Œ Resource ID del SQL Arc correspondiente.

## 16. Auditar Agente - Evaluar cumplimiento de polÃ­ticas en instancias SQL

## Resource graph explorer

```kusto
// Si tiene microsoft.policyinsights/policystates
PolicyResources
| where type == "microsoft.policyinsights/policystates"
| where properties.resourceId contains "microsoft.azurearcdata/sqlserverinstances"
| project policyAssignment = properties.policyAssignmentName,
          policyDefinition = properties.policyDefinitionName,
          complianceState = properties.complianceState,
          resourceId = properties.resourceId,
          evaluatedAt = properties.timestamp


```

> ðŸ“Œ PolÃ­ticas asignadas a **instancias SQL Arc**.

## 16. Auditar Agente - Evaluar cumplimiento de polÃ­ticas en instancias VM

## Resource graph explorer

```kusto
// Si tiene microsoft.policyinsights/policystates
PolicyResources
| where type == "microsoft.policyinsights/policystates"
| where properties.resourceId contains "microsoft.hybridcompute/machines"
| project policyAssignment = properties.policyAssignmentName,
          policyDefinition = properties.policyDefinitionName,
          complianceState = properties.complianceState,
          resourceId = properties.resourceId,
          evaluatedAt = properties.timestamp
```

> ðŸ“Œ PolÃ­ticas asignadas a **instancias VM Arc**.

## 17. Auditar Agente - MonitorizaciÃ³n instalada

## Resource graph explorer

```kusto
// Si tiene microsoft.hybridcompute/machines/extensions
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where name in~ ("AzureMonitorWindowsAgent", "MicrosoftMonitoringAgent")
| extend machineName = split(id, "/")[8]
| project machineName,
          agentType = name,
          provisioningState = properties.provisioningState,
          version = properties.typeHandlerVersion,
          publisher = properties.publisher,
          resourceGroup,
          location

```

> ðŸ“Œ Tienen **agente de monitoreo** instalado (`AMA` o `MMA`).
> ðŸ“Œ AzureMonitorWindowsAgent Bien | MicrosoftMonitoringAgent Legacy Mal

## 17. Auditar Agente - MonitorizaciÃ³n  versiÃ³n del Agente

## Resource graph explorer

```kusto
// Si tiene microsoft.hybridcompute/machines/extensions
Resources
| where type == "microsoft.hybridcompute/machines/extensions"
| where name in~ ("AzureMonitorWindowsAgent", "MicrosoftMonitoringAgent")
| extend machineName = split(id, "/")[8]
| project machineName,
          agentType = name,
          provisioningState = properties.provisioningState,
          version = properties.typeHandlerVersion,
          publisher = properties.publisher,
          resourceGroup,
          location
```

> ðŸ“Œ PolÃ­ticas asignadas a **instancias VM Arc**.

## 18. Auditar Agente - MonitorizaciÃ³n  ver si envÃ­a datos

## Log Analytics Workspace

```kusto
// Si tiene microsoft.hybridcompute/machines
Heartbeat
| where TimeGenerated > ago(1d)
| where ResourceType == "microsoft.hybridcompute/machines"
| summarize LastSeen = max(TimeGenerated) by Computer

```

> ðŸ“Œ Devuelve mÃ¡quinas Arc que estÃ¡n enviando **Heartbeat**. Si **no aparecen aquÃ­**, aunque tengan agente instalado, entonces probablemente **no tienen una DCR configurada o hay un error**.